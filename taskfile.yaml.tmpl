version: '3'

set: [errexit, nounset, pipefail]
output: interleaved

tasks:
  remote_provision_settings:
    desc: "Bootstrap a new node's settings; seed keys and let chezmoi build the rest"
    aliases: [rps]
    cmds:
      - |
        if [ -z '{{ "{{" }}.NODE{{ "}}" }}' ]; then
          echo "âŒ Error: Specify a node. Example: task provision NODE=macmini"
          exit 1
        fi

        RAW_HOST='{{ "{{" }}.NODE{{ "}}" }}-raw'
        CONF_DIR=".config/chezmoi"
        
        echo "Step 1: ðŸ”‘ Authorizing MBP key..."
        ssh-copy-id -i ~/.ssh/id_ed25519.pub "${RAW_HOST}"

        echo "Step 2: ðŸ›  Installing chezmoi..."
        ssh "${RAW_HOST}" "mkdir -p .local/bin && curl -fsLS get.chezmoi.io/lb | sh"

        echo "Step 3: ðŸ“ Creating config directory..."
        ssh "${RAW_HOST}" "mkdir -p ${CONF_DIR}"
        
        echo "Step 4: ðŸ›° Transferring ONLY the master key..."
        scp ~/.config/chezmoi/key.txt "${RAW_HOST}:${CONF_DIR}/"
        
        echo "Step 5: ðŸš€ Initializing (Automated/No-TTY mode)..."
        ssh '{{ "{{" }}.NODE{{ "}}" }}-raw' "./.local/bin/chezmoi init --apply --force --no-tty git@github.com:pdbartlett/dotfiles.git"
        
        echo 'âœ… {{ "{{" }}.NODE{{ "}}" }} is fully provisioned!'
{{- if stat (joinPath .chezmoi.homeDir ".global_uv") }}
  update:global_uv:
    internal: true
    cmds:
      - |
        if [ ! -d "$HOME/.global_uv" ]; then
          echo "ðŸ’¡ Skipping: No global uv environment found."
          exit 0
        fi
        cd ~/.global_uv
        uv lock --upgrade
        uv sync
{{- else }}
  create:global_uv:
    desc: "Create the global UV science environment"
    cmds:
      - rm -rf ~/.global_uv
      - uv init --bare ~/.global_uv --name guv
      - sed -i '' '/requires-python/d' ~/.global_uv/pyproject.toml
      - uv python pin 3 --project ~/.global_uv
      - |
        uv add --project ~/.global_uv \
          pandas polars numpy jupyterlab ipython scipy matplotlib seaborn
{{ end }}
{{- range .apps }}
  {{- $any_up := index . "any_update" }}
  {{- $osx_up := index . "osx_update" }}
  {{- $any_inst := index . "any_install" }}
  {{- $osx_inst := index . "osx_install" }}
  {{- $check_app := index . "check_app" }}
  {{- $check_bin := index . "check" }}
  {{- $is_osx := eq $.chezmoi.os "darwin" }}
  {{- $installed := false -}}
  {{- if $check_bin }}{{ if lookPath $check_bin }}{{ $installed = true }}{{ end }}{{ end -}}
  {{- if and (not $installed) $is_osx $check_app -}}
    {{- if stat (joinPath "/Applications" $check_app) }}{{ $installed = true }}{{ end -}}
  {{- end -}}
  {{- if not $installed }}
  install:{{ .name }}:
    desc: "Install {{ .name }}"
    cmds:
      {{- if $any_inst }}
      - |
{{ $any_inst | indent 8 }}
      {{- else if and $is_osx $osx_inst }}
      - |
{{ $osx_inst | indent 8}}
      {{- end }}
  {{- end }}

  {{- $any_up := index . "any_update" -}}
  {{- $osx_up := index . "osx_update" -}}

  {{- if and $installed (or $any_up $osx_up) }}
  update:{{ .name }}:
    cmds:
      {{- if $any_up }}
      - |
{{ $any_up | indent 8 }}
      {{- else if and $is_osx $osx_up }}
      - |
{{ $osx_up | indent 8 }}
      {{- end }}
  {{- end }}
{{- end }}

  # --- Aggregators ---

  install:common:
    desc: "Install all common CLI tools"
    cmds:
{{- range .apps }}
  {{- if and (eq .group "common") (not (lookPath .check)) }}
      - task: install:{{ .name }}
  {{- end }}
{{- end }}

  install:fonts:
    desc: "Install all fonts"
    cmds:
{{- range .apps }}
  {{- if eq .group "fonts" }}
      - task: install:{{ .name }}
  {{- end }}
{{- end }}

  update:all:
    desc: "Perform system upgrade and specialized tool updates"
    ignore_error: true
    silent: true
    cmds:
      - banner "System Package Manager"
      {{- if eq .chezmoi.os "darwin" }}
      - brew update && brew upgrade || true
      {{- else -}}
      - sudo apt update
      - sudo apt full-upgrade -y
      {{- end }}
{{- $is_osx := eq .chezmoi.os "darwin" -}}
{{- range .apps }}
  {{- $any_up := index . "any_update" -}}
  {{- $osx_up := index . "osx_update" -}}
  {{- $chk := index . "check" -}}
  {{- if and $is_osx $chk (lookPath $chk) (or $any_up $osx_up) }}
      - banner "Updating {{ .name }}"
      - task: update:{{ .name }}
  {{- else if and $chk (lookPath $chk) $any_up }}
      - banner "Updating {{ .name }}"
      - task: update:{{ .name }}
  {{- end }}
{{- end }}
{{- if stat (joinPath .chezmoi.homeDir ".global_uv") }}
      - task: update:global_uv
{{- end }}
      - task: cleanup

  cleanup:
    desc: "Purge caches and old versions"
    ignore_error: true
    silent: true
    cmds:
      - banner "Cleaning Homebrew"
      - brew cleanup -s &> /dev/null
      {{- if lookPath "uv" }}
      - banner "Cleaning uv cache"
      - uv cache clean &> /dev/null
      {{- end }}
      {{- if lookPath "micromamba" }}
      - banner "Cleaning Micromamba"
      - micromamba clean --all --yes &> /dev/null
      {{- end }}
      {{- if lookPath "tlmgr" }}
      - banner "Cleaning TeX Live backups"
      - sudo tlmgr backup --clean --all &> /dev/null
      {{- end }}

  doctor:
    desc: "Diagnostic view of all managed apps"
    silent: true
    cmds:
      - banner "System Environment"
      - "printf 'OS: %s\n' '{{"{{"}}OS{{"}}"}}'"
      - "printf 'Path Helper Check: %s\n' \"$(command -v tlmgr || echo 'NOT FOUND')\""
      - banner "Managed Apps Status"
{{- range .apps }}
      {{- $installed := false -}}
      {{- if index . "check" }}{{ if lookPath .check }}{{ $installed = true }}{{ end }}{{ end -}}
      {{- if and (not $installed) (eq $.chezmoi.os "darwin") (index . "check_app") -}}
        {{- if stat (joinPath "/Applications" (index . "check_app")) }}{{ $installed = true }}{{ end -}}
      {{- end -}}
      {{- if $installed }}
      - printf '%-20s [INSTALLED]\n' "{{.name}}"
      {{- else  }}
      - printf '%-20s [MISSING]\n' "{{.name}}"
      {{- end }}
{{- end }}
