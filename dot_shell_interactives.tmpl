# ~/.shell_interactives
# Contains functions and interactive shell settings.
# Sourced by .bashrc and .zshrc.

# --- Guard against double-sourcing ---
# This ensures the file is only sourced once per shell session.
if [ -n "$_SHELL_INTERACTIVES_SOURCED" ]; then
  return
fi
_SHELL_INTERACTIVES_SOURCED=1

# --- Source Common Basics ---
# This ensures that environment variables and PATH are set up.
# Using 'test -f' for POSIX compliance, avoiding specific shell builtins like '[[ -f'
if test -f "$HOME/.shell_basics"; then
    . "$HOME/.shell_basics"
fi

# --- Aliases / functions ---
alias utd='task update_all'
mkcd() {
    mkdir -p "$1" && cd "$1"
}
sh_resource() {
    unset _SHELL_INTERACTIVES_SOURCED
    if [ -n "$BASH_VERSION" ]; then
        [ -f "$HOME/.bashrc" ] && . "$HOME/.bashrc"
        echo "Bash configuration reloaded."
    elif [ -n "$ZSH_VERSION" ]; then
        [ -f "$HOME/.zshrc" ] && . "$HOME/.zshrc"
        echo "Zsh configuration reloaded."
    fi
}
tm() {
    tmux new-session -A -s main
}

# --- Optional settings ---
{{ $brewExe := findExecutable "brew" (list "/opt/homebrew/bin" (joinPath .chezmoi.homeDir "homebrew/bin")) }}
{{- if $brewExe -}}
{{- $brewDir := dir $brewExe -}}
# Homebrew (first as may bring multiple executables into PATH)
export PATH="{{ $brewDir }}:$PATH"
export HOMEBREW_AUTO_UPDATE_SECS=14400
export HOMEBREW_CLEANUP_MAX_AGE_DAYS=28
export HOMEBREW_CLEANUP_PERIODIC_FULL_DAYS=7
export HOMEBREW_FORBIDDEN_LICENSES="AGPL-1.0-or-later OSL-1.0+ SSPL-1.0+ CAL-1.0 CPAL-1.0+ CPOL-1.02 EUPL-1.0+ SISSL SISSL-1.2+ Watcom-1.0+ CC-BY-NC-1.0+ CC-BY-NC-ND-1.0+ CC-BY-NC-SA-1.0+"
export HOMEBREW_FORCE_BREWED_CURL=1
export HOMEBREW_FORCE_BREWED_GIT=1
export HOMEBREW_NO_INSECURE_REDIRECT=1
export HOMEBREW_UPGRADE_GREEDY=1
{{- end }}
{{ if stat (joinPath .chezmoi.homeDir ".cargo" "env") }}
# cargo / rustup
. "${HOME}/.cargo/env"
{{- end}}
{{ if lookPath "chezmoi" }}
# chezmoi
alias cm=chezmoi

sh_reload() {
    echo "Reloading shell settings with chezmoi"
    if chezmoi update; then
        sh_resource
    else
        echo "'chezmoi update' failed; shell settings not re-sourced"
    fi
}

sh_reapply() {
    echo "Reapplying shell settings with chezmoi"
    if chezmoi apply; then
        sh_resource
    else
        echo "'chezmoi update' failed; shell settings not re-sourced"
    fi
}
{{- end }}
{{ if stat (joinPath  .chezmoi.homeDir ".nvm") -}}
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
{{- end }}
{{ if lookPath "tlmgr" -}}
# Tex (tlmgr)
tlu() {
    if ! command -v tlmgr &> /dev/null; then
        echo "‚ùå tlmgr not found."
        return 1
    fi
    local TLM=$(which tlmgr)
    echo "üîê Requesting sudo for MacTeX updates..."
    sudo -v
    sudo "${TLM}" update --self --all
}
{{- end }}
{{ if lookPath "uv" -}}
{{- $globalPath := joinPath .chezmoi.homeDir ".global_uv" -}}
{{- if stat $globalPath -}}
# uv
## Core Execution
alias gpy='uv run --project ~/.global_uv python'
alias gipy='uv run --project ~/.global_uv ipython'
alias gjup='uv run --project ~/.global_uv jupyter lab --ip=0.0.0.0'
## Management (Add/Remove packages from anywhere)
alias gadd='uv add --project ~/.global_uv'
alias gpip='uv add --project ~/.global_uv'
alias grm='uv remove --project ~/.global_uv'
## Maintenance & Inspection
alias gsync='uv sync --project ~/.global_uv'
alias glock='uv lock --upgrade --project ~/.global_uv'
alias gout='uv pip list --outdated --project ~/.global_uv'
alias gtree='uv tree --project ~/.global_uv'
## Navigation
alias cdg='cd ~/.global_uv'
{{- end -}}
{{- end }}
