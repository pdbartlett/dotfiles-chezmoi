version: '3'

output: interleaved # This shows output as it happens

tasks:
  provision:
    desc: "Bootstrap a new node: Seed key and let chezmoi build the rest"
    cmds:
      - |
        if [ -z "{{.NODE}}" ]; then
          echo "‚ùå Error: Specify a node. Example: task provision NODE=macmini"
          exit 1
        fi

        RAW_HOST="{{.NODE}}-raw"
        CONF_DIR=".config/chezmoi"
        
        echo "Step 1: üîë Authorizing MBP key..."
        ssh-copy-id -i ~/.ssh/id_ed25519.pub "${RAW_HOST}"

        echo "Step 2: üõ† Installing chezmoi..."
        ssh "${RAW_HOST}" "mkdir -p .local/bin && curl -fsLS get.chezmoi.io/lb | sh"

        echo "Step 3: üìÅ Creating config directory..."
        ssh "${RAW_HOST}" "mkdir -p ${CONF_DIR}"
        
        echo "Step 4: üõ∞ Transferring ONLY the master key..."
        scp ~/.config/chezmoi/key.txt "${RAW_HOST}:${CONF_DIR}/"
        
        echo "Step 5: üöÄ Initializing (Automated/No-TTY mode)..."
        ssh "{{.NODE}}-raw" "./.local/bin/chezmoi init --apply --force --no-tty https://github.com/pdbartlett/dotfiles-chezmoi.git"
        
        echo "‚úÖ {{.NODE}} is fully provisioned!"

  update-all:
    desc: "Attempts to run all updates"
    cmd: echo "TODO"
